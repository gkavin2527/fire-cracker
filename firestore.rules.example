
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an admin
    // IMPORTANT: Replace 'YOUR_ADMIN_USER_UID_HERE' with the actual UID of your admin user
    // OR, if you prefer email based check, ensure the email is verified:
    // function isAdmin() {
    //   return request.auth != null && request.auth.token.email_verified && request.auth.token.email == "gkavin446@gmail.com";
    // }
    // For UID based admin check (generally more secure):
    function isAdmin() {
      return request.auth != null && request.auth.uid == "YOUR_ADMIN_USER_UID_HERE";
    }

    // Products: Public can read, admin can write/delete
    match /products/{productId} {
      allow read: if true;
      allow write, delete: if isAdmin();
    }

    // Categories: Public can read, admin can write/delete
    match /categories/{categoryId} {
      allow read: if true;
      allow write, delete: if isAdmin();
    }

    // Hero Images: Public can read active images, admin can write/delete all
    match /heroImages/{heroImageId} {
      allow read: if resource.data.isActive == true || isAdmin();
      allow write, delete: if isAdmin();
    }

    // Users: Users can read/write their own profile. Admin can read any profile (optional).
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Optional: allow admin to read any user profile
      // allow read: if (request.auth != null && request.auth.uid == userId) || isAdmin();
      // allow write: if request.auth != null && request.auth.uid == userId; // Only user can write their own
    }

    // Orders:
    // - Users can create their own orders.
    // - Users can read their own orders.
    // - Users can update the status of their own orders if the new status is 'Cancelled'
    //   and the current status is 'Pending' or 'Processing'.
    // - Admins can read all orders and update status of any order.
    match /orders/{orderId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow read: if (request.auth != null && request.auth.uid == resource.data.userId) || isAdmin();
      allow update: if 
        ( isAdmin() ) || // Admin can update anything
        ( request.auth != null && request.auth.uid == resource.data.userId && // User is owner
          request.resource.data.status == 'Cancelled' && // New status is Cancelled
          (resource.data.status == 'Pending' || resource.data.status == 'Processing') && // Old status was Pending or Processing
          diff(resource.data, request.resource.data).affectedKeys().hasOnly(['status']) // Only status field is changed
        );
      // No direct delete for orders by users, admin can delete if needed via console or specific admin function.
      // allow delete: if isAdmin();
    }
  }
}
